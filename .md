# **Building an E-Commerce Site on Tor Using Whonix**  

Whonix provides the most secure foundation for hosting onion services. This guide covers creating a Tor e-commerce site using Whonix's isolated environment.  

## **System Overview**  
```mermaid
graph LR
A[Internet] --> B[Tor Network]
B --> C[Whonix-Gateway]
C --> D[Whonix-Workstation]
D --> E[Onion Service<br>E-Commerce Site]
D --> F[Database]
```

## **Step 1: Whonix Setup**  
1. Download **Whonix Gateway** and **Workstation** from [whonix.org](https://www.whonix.org)  
2. Install in VirtualBox (use **Bridged Adapter** for host network)  
3. Start both VMs (Gateway first, then Workstation)  

## **Step 2: Configure Onion Service**  
### In Whonix-Gateway:  
1. Edit Tor config:  
```bash
sudo nano /etc/torrc.d/50_user.conf
```  
2. Add hidden service configuration:  
```ini
HiddenServiceDir /var/lib/tor/ecom_service/
HiddenServicePort 80 10.152.152.11:8080  # Forward to Workstation
```  
3. Restart Tor:  
```bash
sudo systemctl restart tor
```  
4. Get your onion address:  
```bash
sudo cat /var/lib/tor/ecom_service/hostname
```  

## **Step 3: Workstation Setup**  
### Install Dependencies:  
```bash
sudo apt update && sudo apt upgrade -y
sudo apt install python3-pip nginx
pip3 install flask python-dotenv
```

## **Step 4: E-Commerce Application**  
### Directory Structure:  
```
/var/www/ecom-store/
├── app.py
├── .env
├── templates/
│   └── index.html
└── static/
```

### `app.py` (Flask Application):  
```python
from flask import Flask, render_template
import os

app = Flask(__name__)

# Load configuration
app.config['SECRET_KEY'] = os.getenv('SECRET_KEY', 'default_secret')

products = [
    {"id": 1, "name": "Product A", "price": "0.015 XMR"},
    {"id": 2, "name": "Product B", "price": "0.023 XMR"},
    {"id": 3, "name": "Product C", "price": "0.008 XMR"}
]

@app.route('/')
def index():
    return render_template('index.html', products=products)

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=8080)
```

### `templates/index.html` (Product Listing):  
```html
<!DOCTYPE html>
<html>
<head>
    <title>Whonix Store</title>
    <meta charset="utf-8">
    <style>
        body { font-family: sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .product { border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .monero-address { font-family: monospace; background: #eee; padding: 5px; }
    </style>
</head>
<body>
    <h1>Whonix Marketplace</h1>
    <p>All transactions require PGP-encrypted communication</p>
    
    <div class="products">
        {% for product in products %}
        <div class="product">
            <h3>{{ product.name }}</h3>
            <p>Price: <strong>{{ product.price }}</strong></p>
            <button onclick="location.href='mailto:orders@yourstore.onion?subject=Order: {{ product.name }}'">
                Order via Email
            </button>
        </div>
        {% endfor %}
    </div>
    
    <div class="payment-info">
        <h3>Payment Instructions</h3>
        <p>Send Monero (XMR) to:</p>
        <p class="monero-address">84YVz3KjD4Fc5V7... (generate new for each order)</p>
        <p><em>Include PGP-encrypted shipping details with payment</em></p>
    </div>
    
    <div class="security">
        <h3>Security Policy</h3>
        <ul>
            <li>No JavaScript used on this site</li>
            <li>No cookies or tracking</li>
            <li>All communications must be PGP-encrypted</li>
            <li>No order history retained</li>
        </ul>
    </div>
</body>
</html>
```

## **Step 5: Security Hardening**  
### In Whonix-Workstation:  
1. Disable logging:  
```bash
sudo sed -i 's/access_log.*/access_log off;/' /etc/nginx/nginx.conf
sudo systemctl disable nginx
```  
2. Configure firewall (allow only gateway access):  
```bash
sudo ufw default deny incoming
sudo ufw default allow outgoing
sudo ufw allow from 10.152.152.10 to any port 8080
sudo ufw enable
```  
3. Run application securely:  
```bash
torsocks python3 /var/www/ecom-store/app.py
```  

## **Step 6: Payment System**  
1. **Monero Wallet Setup**:  
```bash
sudo apt install monero-wallet-cli
monero-wallet-cli --generate-new-wallet /var/www/ecom-store/monero_store
```  
2. For each order:  
   - Generate new subaddress  
   - Verify payment with wallet CLI  
   - Transfer funds out immediately after confirmation  

## **Operational Security Checklist**  
- [ ] All access through Whonix VMs only  
- [ ] Tor Stream Isolation enabled  
- [ ] No product images (metadata risks)  
- [ ] New XMR address per transaction  
- [ ] Daily wallet sweeps to cold storage  
- [ ] PGP mandatory for communications  
- [ ] Whonix updates applied weekly  

**Final Onion URL Format**:  
`http://yourgeneratedaddress.onion`  

This setup leverages Whonix's security architecture while maintaining a functional e-commerce presence. Remember that operational security is continuous - never become complacent.